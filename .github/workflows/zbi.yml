name: debian

on:
  workflow_dispatch:

jobs:
  secure-rdp:
    runs-on: ubuntu-latest
    timeout-minutes: 3600

    steps:
      - name: Install Desktop Environment and xrdp
        run: |
          sudo apt-get update
          sudo DEBIAN_FRONTEND=noninteractive apt-get install -y \
            xfce4 xfce4-goodies xrdp dbus-x11 \
            firefox-esr \
            gedit \
            file-roller \
            fonts-liberation
          
          # Configure xrdp to use Xfce
          echo "xfce4-session" | sudo tee /etc/skel/.xsession
          
          # Start xrdp service
          sudo systemctl enable xrdp
          sudo systemctl start xrdp
          
          # Allow RDP through firewall
          sudo ufw allow 3389/tcp || true

      - name: Create RDP User with Secure Password
        run: |
          # Generate a secure random password
          PASSWORD=$(openssl rand -base64 24 | tr -d "=+/" | cut -c1-20)
          
          # Create user with the generated password
          sudo useradd -m -s /bin/bash RDP
          echo "RDP:$PASSWORD" | sudo chpasswd
          
          # Add user to sudo group for admin access
          sudo usermod -aG sudo RDP
          
          # Create .xsession file for the user
          echo "xfce4-session" | sudo tee /home/RDP/.xsession
          sudo chown RDP:RDP /home/RDP/.xsession
          
          # Save credentials to environment
          echo "RDP_CREDS=User: RDP | Password: $PASSWORD" >> $GITHUB_ENV
          echo "RDP_PASSWORD=$PASSWORD" >> $GITHUB_ENV
          
          # Verify user was created
          if ! id RDP &>/dev/null; then
              echo "User creation failed"
              exit 1
          fi

      - name: Install Tailscale
        run: |
          # Add Tailscale's package signing key and repository
          curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
          curl -fsSL https://pkgs.tailscale.com/stable/debian/bookworm.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
          
          # Install Tailscale
          sudo apt-get update
          sudo apt-get install -y tailscale

      - name: Establish Tailscale Connection
        run: |
          # Bring up Tailscale with the provided auth key and set a unique hostname
          sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-runner-$GITHUB_RUN_ID
          
          # Wait for Tailscale to assign an IP
          TAILSCALE_IP=""
          retries=0
          while [ -z "$TAILSCALE_IP" ] && [ $retries -lt 10 ]; do
              TAILSCALE_IP=$(tailscale ip -4 2>/dev/null || true)
              sleep 5
              retries=$((retries + 1))
          done
          
          if [ -z "$TAILSCALE_IP" ]; then
              echo "Tailscale IP not assigned. Exiting."
              exit 1
          fi
          
          echo "TAILSCALE_IP=$TAILSCALE_IP" >> $GITHUB_ENV
          echo "Tailscale IP: $TAILSCALE_IP"

      - name: Verify RDP Accessibility
        run: |
          echo "Tailscale IP: $TAILSCALE_IP"
          
          # Test if xrdp is listening on port 3389
          if ! sudo netstat -tuln | grep -q ':3389'; then
              echo "xrdp is not listening on port 3389"
              exit 1
          fi
          
          # Test local connectivity
          if ! timeout 5 bash -c "cat < /dev/null > /dev/tcp/localhost/3389" 2>/dev/null; then
              echo "Cannot connect to RDP port 3389 locally"
              exit 1
          fi
          
          echo "RDP service is running and accessible!"

      - name: Maintain Connection
        run: |
          echo ""
          echo "=== RDP ACCESS ==="
          echo "Address: $TAILSCALE_IP"
          echo "Username: RDP"
          echo "Password: $RDP_PASSWORD"
          echo "=================="
          echo ""
          
          # Keep runner active indefinitely (or until manually cancelled)
          while true; do
              echo "[$(date)] RDP Active - Use Ctrl+C in workflow to terminate"
              sleep 300
          done
